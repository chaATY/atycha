---
title: 游戏保护和辅助
date: 2023-11-16
author: CHA.ATY
environment:
  - Windows10-22H2_19045.3570
tags:
  - Game
---

![](https://img.shields.io/badge/Windows10-22H2_19045.3570-green.svg)

# 一、游戏保护

外挂基本定义：未经官方许可的，可以达到游戏作弊效果的游戏工具。使用这种工具，能获得其他诚实玩家无法达到、或者在短期内得到其他诚实玩家必须通过长期运行游戏才能得到的游戏结果。满足上述效果的工具，称之为“外挂”。

游戏保护手段如下：

![](网络安全-GameSecurity/res/32.png)

---

# 二、辅助分类

- 内存类：相对与图色类更容易被游戏查到，特征码查找困难，入门难。
	- 第一种方法是利用 virtual X driver（虚拟设备驱动程序）直接查找游戏内存分配地址，这种方法需外挂开发人员有良好的编程基础和系统的底层驱动知识，是技术较难的一种方法，门槛较高。
	- 第二种方法就是用 ToolHelp API 函数，该函数是用来枚举进程和模块，获取进程和模块的 ID 与信息。黑客利用 ReadProcess Memory 函数从网络游戏的进程中读取到游戏的内存数据，但是该方法没有修改内存的函数，不能往内存里写数据，所以这种方法需要其他方法的配合，具有一定的弊端。
	- 第三种方法是利用游戏进程的对应函数，这种方法比前两种要方便和简单很多，游戏进程的对应函数很容易就能得到，例如利用：ReadProcessMemory 和 WriteProcess-Memory 两个函数对游戏进程进行读取和写入，这种方法是当下最流行最受欢迎的方法，该方法能修改市面上大多数的游戏内存。
	- 容易封号，游戏更新就需要重新分析
	- 第四种 [DMA硬件](https://www.52pojie.cn/thread-1856534-1-1.html)
		- 使用FPGA进行DMA（Direct Memory Access，直接内存访问）作弊原理：主要是通过FPGA直接访问计算机内存中的数据，可以进行数据修改（血量，金币等），或者将数据导出来到其他设备上显示（对手位置）。
		- 那为什么要使用FPGA进行操作呢？主要原因就是FPGA灵活，这种行业就是灰色产业，不会有专用的ASIC（未来可能有），所以FPGA的优势就体现出来了；
		- 二是驱动易改，可以模拟电脑中的网卡、GPU等，这样即使官方查到，最多就是硬件设备异常，不会直接查到KG的证据。
		- 使用基于 FPGA 的设备具有许多优势：其一是基于 FPGA 的硬件提供对 64 位内存空间的访问，而无需依赖目标系统上运行的内核；其二是基于 FPGA 的设备也更加稳定。
- 图色AI类：有很多问题复杂的图色问题无法处理，准确性不高，效率低下等。
	- 以按键精灵为代表的一类，它本质上不进入游戏内部，只是在外围通过识别游戏图片、文字等方式来模拟点击，达到获益的目的。将网络游戏中很繁琐的动作或者重复的无聊的很费玩家时间的流程和任务使用外挂帮助玩家完成，达到方便和解放玩家的目的。例如在网络游戏《地下城与勇士》中，角色存在等级制度，等级越高，可以带越好的装备，但是练级并不是一件美妙的事情，想要达到满级更是要花费很长的时间，在游戏满级前就要一直杀怪刷图，可能同一个图要刷几百遍。而刷图杀怪的过程就要一直按技能键和普攻键，比如普攻是 X 键，一天就要按几千上万遍，及其无聊和枯燥，所以外挂制作商开发出这种能够代替人们进行操作的外挂，可以利用其按键连点功能，来降低游戏的枯燥和痛苦，按一次就可以连续使用 X 键位，达到一直普攻的效果，在游戏人物进游戏后只需按一下 X 键，角色就可以一直攻击，玩家只需要控制角色的移动就可以了，让玩家远离这种无趣的连续点击键盘或者鼠标的操作。

---

# 三、防御外挂的一些方法

1. 变量检测。设置一个全局变量。在游戏关键功能函数的外层函数赋值，在功能函数内部检测。正常游戏调用肯定是一步一步执行的，必然会对变量赋值，但是游戏外挂会直接调用功能函数，函数内部发现变量没有被赋值，而检测到外挂。
2. 堆栈检测。变量检测有一个弱点，那就是必须设置一个全局变量来传递信息，有可能被外挂作者利用内存扫描工具来回扫描发现变量，在调用前提前赋值规避检测。堆栈检测避免了这一点，实现原理是在游戏功能函数内部读取堆栈信息，以此得到调用函数的代码来源，如果发现并非正常代码调用的堆栈，那就是外挂程序了。
3. 数据检测。不断读取关键数据以查看是否被外挂篡改，不过直接查看太过容易被外挂作者发现，一般混在游戏正常读取数据的代码中间接查看是否异常。
4. CRC检测。CRC检测主要是保护游戏代码不被外挂程序篡改，游戏中有一些关键逻辑代码，比如如果血量为0的话会判断人物死亡，外挂课程可以恶意篡改判断逻辑，让程序无论怎样都不会执行死亡代码，从而实现无敌效果。CRC检测的原理是，不断的读取关键代码的值，以此查看代码是否被篡改。CRC之类算法对自身的完整效验勾挂函数的完整效验，一些重要代码段另外单独校验，校验相关代码段VMP，必要的话返回服务器中验证。
5. 进程检测。获取系统进程列表，检测是否有常见外挂的进程名，如果检测到存在外挂进程。直接强制下线。
6. 行为检测。现在大力发展的新兴检测 如某企鹅的DXF就有此保护机制 效果甚好 甚至连图色辅助都无法在其幸存 搞得 一些人直接上机械臂，与上面几种方式不同：此种检测主要是检测用户的行为，主要是利用深度学习人工智能大数据对玩家的行为数据进行分析。比如一局游戏中一位玩家爆头和击杀率都特别的高，鼠标移动的轨迹几乎为直线，那么就可以把这些数据异常的玩家抽调出来转入人工检测，或者极为异常的直接封号处理。

---

# 四、防篡改思路

1. 游戏登陆相关封包处理。游戏的登录封包尽量复杂化，不同的封包类型中部分数据采用多重加密是必要的，多个端口乱序通讯，这些登陆分包是一次性的不用太担心算法效率问题，而此操作却可以大大增加逆向难度。
2. 游戏反调试保护。主流思想是驱动层进行调试器进程检测、标志位检测，HOOK重要函数等方法以及给游戏执行文件加猛壳利用壳的功能实现反调。
3. 服务器数据校验。收到客户端发来的消息后，对消息的合法性进行验算。比如上面提到的秒通关封包漏洞。服务器可以针对战斗数据做校验来进一步判断是否真的通关成功。
4. 快速小规模更新游戏。更新内容是代码混淆，基址变更。
5. 协议非对称加密交换密钥，对称加密传输内容，保护好服务端私钥，防止中间人攻击。流式加密，同样包发两次内容不一样。
6. 不定期弹出反外挂答题，答正确奖励经验，错误就掉线。
7. 客户端加密加壳防止调试和注入，程序签名防止篡改二进制。
8. 重要代码放虚拟机或者脚本里运行（脚本字节码需需改），一般黑客主要分析反汇编，复杂逻辑多套几层黑客就晕了。
9. 关键数据不落内存，一律使用getxx，setxx之类的接口，后面将真实数据经过变换以后才落内存。
10. 守护进程动态跟踪监控情况。
11. 决定性逻辑永远放在服务端。
12. 发现某黑客/外挂工具利用某漏洞破解了游戏，先看影响大不大，再看他挣不挣钱，影响一般又不挣钱的话可以先养着他，等他挣钱了用户多了，大型活动之前，一条指令就把它封了，用户退款都可以弄得他爬不起来。
13. 必须要放在客户端计算的逻辑将输入和结果hash同步给其他客户端验算，不对就踢掉。
14. 当检测到客户端触碰到某规则不要急着踢掉它，而是有概率踢掉，还要随机几秒踢掉，这样黑客发现一会这里断一会那里断，就蒙圈了。

---

> 版权声明©：
>
> 本文为 CHA.ATY 的原创文章，遵循 [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) 许可证进行授权，转载请附上原文出处链接及本声明。
>
> 作者：CHA.ATY
>
> 邮箱：2165150141@qq.com