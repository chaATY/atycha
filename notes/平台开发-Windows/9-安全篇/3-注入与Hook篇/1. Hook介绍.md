---
title: Hook介绍
date: 2023-11-06 20:09
author: CHA.ATY
tags:
  - C
  - Windows
  - Hook
---

![](https://img.shields.io/badge/C-17-green.svg) ![](https://img.shields.io/badge/C++-17-green.svg)
![](https://img.shields.io/badge/visual_studio-2019-green.svg)
![](https://img.shields.io/badge/Windows10-22H2_19045.3570-green.svg)

# 一、前言

Hook，中文里常常被译作“钩子”或者“挂钩”，其实是Windows操作系统里的一种中断消息机制。

是一种可以改变程序执行流程的技术，也就是讲程序原有的执行流程拦截，更改程序流向，并可以执行自己新代码的技术。

举个不恰当的例子：
- 通俗来说，就是一条高速公路，我们去追击一个罪犯(要截获的消息或事件)，然后在他要经过的地方提前埋下埋伏，等到罪犯到来时，实现截获，并执行自己的操作。
- 或者说我们就是坏蛋，在要道打劫好人，“此树是我栽，此路是我开，要想过此路，留下买路财”

游戏攻防中作用：
1. 当代码执行到某行时,获取寄存器值和内存里的值，进行调试分析，例如hook明文包
2. 当代码执行到某行时,插入想执行的代码.例如迅雷拦截发包函数
3. 当代码执行到某行时,修改寄存器,达到某些篡改目的

---

# 二、Hook 作用

Hook技术被广泛应用于安全的多个领域，比如：
- 杀毒软件的主动防御功能，涉及到对一些敏感API的监控，就需要对这些API进行Hook；
- 窃取密码的木马病毒，为了接收键盘的输入，需要Hook键盘消息；
- 甚至是Windows系统及一些应用程序，在打补丁时也需要用到Hook技术。

---

# 三、基本原理

Hook技术的原理的：就是修改程序的运行时 PC"指针"，让程序跳到我们指定的代码中运行，运行完我们的程序，程序PC指针又回到原来程序的下一条指令。

简而言之：就篡改程序的运行路径，来执行我们的程序。

示例：在notepad.exe和kernel32.dll之间挂上一个“钩子”，把它们要使用的CreateFile()函数替换掉，换成MyCreateFile()函数，实现我们想要的自定义功能。
![[编程语言-1-汇编/res/18.png]]

---

# 四、Hook分类

Hook大体分为应用层和内核层Hook


- 消息 Hook
	- 进程内 Hook（自己 Hook 自己）
	- 全局 Hook（Dll注入）
- API Hook
- HoxFix Hook
- Object Hook
- IDT Hook
- IRP Hook
- inline Hook
- IAT Hook
- EAT Hook
- SysEnter Hook
- 调试 Hook
	- CC断点hook
	- 内存断点hooK
- SSDT Hook
硬断 Hook（VEH异常+硬件断点）
VT Hook
- MSR HOOK
- EPT HOOK

# 五、初级 Hook

- 方式：对 Hook 点用 call 或 jmp 替换
- 优点：原理简单粗暴，容易理解，适合新手入门
- 缺点：
	- 1. 无法规避 CRC32 检测，很容易别检测到。
	- 2. jmp 或 Hook 至少破坏 5 个 byte，有时为了防止前后的机器码粘连，还需要使用额外 NOP 断开，造成更多破坏，动静太大。
	- 3. 如果 Hook 遇到了 jmp 或 call，修复时还需要重新计算 Hook 点原来的目的地到现在自定义逻辑处的偏移，然后从新的目的地跳转过去，逻辑不难，但是有点复杂，容易算错。
	- 4. 从 Hook 点跳转到自己的处理逻辑太明显，很容易被其他人逆向找到，然后"黑吃黑"。

---

# 六、普通Hook

- 方式：对 Hook 点用 0xCC 替换。
- 原理：找准 Hook 点， 更改为 0xCC ，原程序执行到这里时产生异常。这里可以自定义异常处理函数（通过 AddVectoredExceptionHandler 添加）来实现自定义的逻辑，然后跳转回原 Hook 点执行。
- 优点：
	- 1. 原理和 OD、x32dbg 等调试器的断点一样，这里只需要破坏一个字节；
	- 2. 并不直接从 Hook 点跳转到自定义的处理函数，不容易被其他人逆向找到；
- 缺点：还是回破坏 1 个字节，还是无法通过 CRC32 检测。

---

# 七、高级Hook

- 方式：对 Hook 点下硬件断点。
- 原理：找准 Hook 点，通过设置 DR0~DR3、DR7 下硬件断点，程序执行到这里时产生异常，由我们自定义的异常处理函数（通过 AddVectoredExceptionHandler 添加）来实现自定义逻辑。
- 优点：
	- 1. 对原机器码没有任何改动，Hook 后完全不用修复机器码。
	- 2. 可以绕过普通的 CRC32 检测。
	- 3. 并不直接从 Hook 点跳转到自定义的处理函数，不容易被其他人逆向找到；
- 缺点：
	- 1. 硬件断点只有4个（当然可以通过VT实现无限硬件断点）
	- 2. 原程序一旦设置 DR0~DR4为0，或者 DR7 的硬件断点开关为0，硬件断点立即失效（PG 为了做 CRC32 检测，是提前对 DR 寄存器清零了的）

---

# 八、神级Hook

- 方式：VT读写分离
- 原理：找准 Hook 点，更改原机器码为 jmp 或 call，跳转到自己的处理逻辑。然后修复被破坏的机器码，接着跳转回原 Hook 点继续执行。
- 优点：通过页的读写分离，吊打所有的 CRC32检测和 dll 模块检测。
- 缺点：
	- 1. 要开启 VT：由物理CPU要执行 host 和 guest 的代码，虚拟内存还要转换成物理机内存（也即是 EPT），性能有损耗。
	- 2. 做成 WG 后普通用户使用也需要开启 VT，比较麻烦。
	- 3. VT 是可以嵌套的。如果其他程序先一步开启了 VT，自己的程序 VT 还是在别人 VT 的监控之下，一举一动还是被监控着。

---

> 版权声明©：
>
> 本文为 CHA.ATY 的原创文章，遵循 [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) 许可证进行授权，转载请附上原文出处链接及本声明。
>
> 作者：CHA.ATY
>
> 邮箱：2165150141@qq.com