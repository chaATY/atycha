---
title: Intel汇编-调试寄存器
date: 2023-11-07 19:02
author: CHA.ATY
environment:
  - Windows10-22H2_19045.3570
tags:
  - Intel汇编
---

# 一、前言

A-32 处理器定义了 8个 调试寄存器，分别为 DR0~DR7。在32位模式下，它们是32位的；在64位模式下，它们是64位的。

下图为Intel手册提供的32位操作系统下8个调试寄存器的图示(Intel手册卷3 17章第二节 Debug Registers)
![](编程语言-1-汇编/res/2.png)

- 调试寄存器有8个，分别为 Dr0 到 Dr7，可以直接被读写操作 。
- DR0~DR3 是调试地址寄存器，这 4个 调试地址寄存器是用来设置 内存（线性地址） 或 I/O 地址的，所以用户最多能够设置 4个 硬件断点。
- Dr4 和 Dr5 是保留的。  
- DR7 是调试控制寄存器，定义断点的中断条件。64位时，高32位保留未用。
- DR6 是调试状态寄存器，向调试器报告事件的详细信息。64位时，高32位保留未用。

调试寄存器作用：
1. 设置发生断点的地址  
2. 设置断点的长度（1，2，4个字节，但是执行断点只能是1）  
3. 设置在调试异常产生的地址执行的操作  
4. 设置断点是否可用  
5. 在调试异常产生时，调试条件是否是可用  

---

# 二、调试地址寄存器 DR0~DR3

DR0~DR3 是调试地址寄存器，这 4个 调试地址寄存器是用来设置 内存（线性地址） 或 I/O 地址的。

设置在内存中间的断点，这个地址是断点的线性地址而不是[物理地址](https://so.csdn.net/so/search?q=%E7%89%A9%E7%90%86%E5%9C%B0%E5%9D%80&spm=1001.2101.3001.7020)，因为CPU是在线性地址被翻译为物理地址之前来做断点匹配工作的。

在保护模式下，不能针对一个物理内存地址设置断点。

**思考**：假如在 Dr0[寄存器](https://so.csdn.net/so/search?q=%E5%AF%84%E5%AD%98%E5%99%A8&spm=1001.2101.3001.7020)中写入线性地址，是否所有线程都会受影响？  
**答案**：不对，每个线程都拥有一份独立的寄存器，切换线程时，寄存器的值也会被切换。

---

# 三、调试控制寄存器 DR7

DR7 有 24位 被划分成 4组 分别与 4个 调试地址寄存器相对应，如 L0、G0、R/W0、LEN0 这6位与DR0相对应，以此类推。DR7各个位域的含义，如下：

1. R/W0~R/W3
	- 全称：读写域
	- 比特位：
		- R/W0：16，17
		- R/W1：20，21
		- R/W2：24，25
		- R/W3：28，29
	- 描述：分别与DR0～DR3这4个调试地址寄存器相对应，用来指定被监控地址的访问类型，其含义如下：
		- 00：仅当执行对应地址的指令时中断
		- 01：仅当向对应地址写数据时中断
		- 10：386和486不支持此组合。对于以后的CPU，可以通过把CR4寄存器的DE（调试扩展）位设为1启用该组合，其含义为“当向相应地址进行输入输出（即I/O读写）时中断” 
		- 11：当向相应地址读写数据时都中断，但是从该地址读取指令除外
2. LEN0~LEN3
	- 全称：长度域
	- 比特位：
		- LEN0：18，19
		- LEN1：22，23
		- LEN2：26，27
		- LEN3：30，31
	- 描述：分别与DR0～DR3这4个调试地址寄存器相对应，用来指定要监控的区域长度，其含义如下：
		- 00：1字节长
		- 01：2字节长
		- 10：8字节长（奔腾4或至强CPU）或未定义（其他处理器）
		- 11：4字节长 注意：如果对应的R/Wn为0（即执行指令中断），那么这里的设置应该为0
1. L0~L3
	- 全称：局部断点启用
	- 比特位：
		- L0：0
		- L1：2
		- L2：4
		- L3：6
	- 描述：分别与DR0～DR3这4个调试地址寄存器相对应，用来启用或禁止对应断点的局部匹配。如果该位设为1，当CPU在当前任务中检测到满足所定义的断点条件时便中断，并且自动清除此位。如果该位设为0，便禁止此断点。
2. G0~G3
	- 全称：全部断点启用
	- 比特位：
		- G0：1
		- G1：3
		- G2：5
		- G3：7
	- 描述：分别对应DR0～DR3这4个调试地址寄存器，用来全局启用和禁止对应的断点。如果该位设为1，当CPU在任何任务中检测到满足所定义的断点条件时都会中断；如果该位设为0，便禁止此断点。与L0～L3不同，断点条件发生时，CPU不会自动清除此位。
3. LE和GE
	- 全称：启用局部或者全局（精确）断点(Local and  Global (exact)breakpointEnable）
	- 比特位：
		- LE：8
		- GE：9
	- 描述：从486开始的IA-32处理器都忽略这两位的设置。此前这两位是用来启用或禁止数据断点匹配的。对于早期的处理器，当设置有数据断点时，需要启用本设置，这时CPU会降低执行速度，以监视和保证当有指令要访问符合断点条件的数据时产生调试异常。
4. GD
	- 全称：启用访问检测（General DetectEnable）
	- 比特位：13
	- 描述：启用或禁止对调试寄存器的保护。当设为1时，如果CPU检测到将修改调试寄存器（DR0～DR7）的指令，CPU会在执行这条指令前产生一个调试异常。

读写域R/Wn，占两个二进制位，可以指定4种访问方式。通过设置读写域，可以指定断点的访问类型。以下是3类典型的读写域使用方式：
- 读/写内存中的数据时中断：又称为数据访问断点(data access breakpoint)。利用数据访问断点，可以监控对全局变量或局部变量的读写操作。以WinDBG 为例，对内存区进行写操作时中断，ba w4 00401200,ba 代表break on access, w 表示写(write)，4 表示4字节。对内存区进行读操作中断，ba r4 00401200，r 表示读(read)。
- 执行内存中的代码时中断：又称为代码访问断点(code access breakpoint)或指令断点(instruction breakpoint)
- 读写I/O(输入输出)端口时中断：又称为I/O访问断点(Input/Output access breakpoint)。

LENn(n=0,1,2,3,位于DR7中)位段可以指定1、2、4或8字节长的范围。

代码访问断点，长度域应为00，表示1字节长度。

数据和I/O访问断点，有两点需要注意：
- 只要断点区域中的任一字节在被访问的范围内，都会触发该断点。
- 边界对齐要求，2字节区域必须按字（word）边界对齐，4字节区域必须按双字（doubleword）边界对齐，8字节区域必须按4字（quadword）边界对齐。也就是说，CPU在检查断点匹配时会自动去除相应数量的低位。如果地址没有按要求对齐，可能无法实现预期的结果。例如，假设希望通过将DR0设为0xA003、将LEN0设为11（代表4字节长）实现任何对0xA003～0xA006内存区的写操作都会触发断点，那么只有当0xA003被访问时会触发断点，对0xA004、0xA005和0xA006处的内存访问都不会触发断点。因为长度域指定的是4字节，所以CPU在检查地址匹配时，会自动屏蔽起始地址0xA003的低2位，只是匹配0xA000。而0xA004、0xA005和0xA006屏蔽低2位后都是0xA004，所以无法触发断点。

---

# 四、调试异常

IA-32 架构分配了**两个中断向量**来支持软件调试，即 向量1 和 向量3。
- 向量1 用于其他情况的调试异常，简称调试异常(debug exception ,即#DB)。
- 向量3 用于 `INT 3` 指令产生的断点异常(breakpoint exception，即#BP)。

硬件断点产生的是调试异常，CPU 会执行 1号向量 所对应的处理例程。

导致调试异常的各种情况，如下表：

| 异常情况 | DR6 标志 | DR7 标志 | 异常类型 |
| --- | --- | --- | --- |
| 因为EFlags[TF]=1而导致的单步异常 | BS=1 |  | 陷阱 |
| 调试寄存器DRn和LENn定义的指令断点 | Bn=1 and (Gn=1 or Ln=1) | R/Wn=0 | 错误 |
| 调试寄存器DRn和LENn定义的写数据断点 | Bn=1 and (Gn=1 or Ln=1) | R/Wn=1 | 陷阱 |
| 调试寄存器DRn和LENn定义的I/O读写断点 | Bn=1 and (Gn=1 or Ln=1) | R/Wn=2 | 陷阱 |
| 调试寄存器DRn和LENn定义的数据读（不包括取指）写断点 | Bn=1 and (Gn=1 or Ln=1) | R/Wn=3 | 陷阱 |
| 当DR7的GD位为1时，企图修改调试寄存器 | BD=1 |  | 错误 |
| 任务状态段（TSS）的T标志为1时进行任务切换 | BT=1 |  | 陷阱 |

对于错误类调试异常，因为恢复执行后断点条件仍然存在，所以为了避免反复发生异常，调试软件必须在使用 `IRETD` 指令返回重新执行触发异常的指令前将标志寄存器的 RF（Resume Flag）位设为 1，告诉 CPU 不要在执行返回后的第一条指令时产生调试异常，则 CPU 执行完该条指令后会自动清除 RF标志。

---

# 五、调试状态寄存器 DR6

调试状态寄存器（DR6）的作用是当CPU检测到匹配断点条件的断点或有其他调试事件发生时，用来向调试器的断点异常处理程序传递断点异常的详细信息，以便使调试器可以很容易地识别出发生的是什么调试事件。例如，如果B0被置为1，那么就说明满足DR0、LEN0和R/W0所定义条件的断点发生了。

调试状态寄存器（DR6）各个标志位具体含义，如下表：

| 简称 | 全称 | 比特位 | 描述 |
| --- | --- | --- | --- |
| B0 | Breakpoint 0 | 0 | 如果处理器检测到满足断点条件0的情况，那么处理器会在调用异常处理程序前将此位置为1 |
| B1 | Breakpoint 1 | 1 | 如果处理器检测到满足断点条件1的情况，那么处理器会在调用异常处理程序前将此位置为1 |
| B2 | Breakpoint 2 | 2 | 如果处理器检测到满足断点条件2的情况，那么处理器会在调用异常处理程序前将此位置为1 |
| B3 | Breakpoint 3 | 3 | 如果处理器检测到满足断点条件3的情况，那么处理器会在调用异常处理程序前将此位置为1 |
| BD | Breakpoint 13 | 13 | 这一位与DR7的GD位相联系，当GD位被置为1，而且CPU发现了要修改调试寄存器（DR0～DR7）的指令时，CPU会停止继续执行这条指令，把BD位设为1，然后把执行权交给调试异常（#DB）处理程序 |
| BS | Breakpoint 14 | 14 | 这一位与标志寄存器的TF位相联系，如果该位为1，则表示异常是由单步执行（single step）模式触发的。与导致调试异常的其他情况相比，单步情况的优先级最高，因此当此标志为1时，也可能有其他标志也为1 |
| BT | Breakpoint 15 | 15 | 这一位与任务状态段（TSS）的T标志（调试陷阱标志，debugtrap flag）相联系。当CPU在进行任务切换时，如果发现下一个任务的TSS的T标志为1，则会设置BT位，并中断到调试中断处理程序 |

---

> 版权声明©：
>
> 本文为 CHA.ATY 的原创文章，遵循 [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) 许可证进行授权，转载请附上原文出处链接及本声明。
>
> 作者：CHA.ATY
>
> 邮箱：2165150141@qq.com