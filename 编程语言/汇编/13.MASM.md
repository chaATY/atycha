---
title: MASM汇编
date: 2023-11-11 17:26
author: CHA.ATY
environment:
  - Windows10-22H2_19045.3570
  - C17
  - visual_studio-2019
tags:
  - MASM
  - Windows
---

# 一、前言

MASM是Microsoft Macro Assembler的缩写，是微软公司为x86微处理器家族开发的汇编开发环境，拥有可视化的开发界面，使开发人员不必再使用DOS环境进行汇编的开发，编译速度快，支持80x86汇编以及Win32Asm，是Windows下开发汇编的利器。

开发环境：visual studio 2019、插件AsmDude(汇编提示)

---

# 二、新建项目，配置项目

安装好vs2019以后新建项目，项目类型选择`C++  console  empty project`

创建好项目以后右击项目，点击生成依赖项，生成自定义，勾选`masm`，确定

## Windows版的 hello world

接下来添加汇编源文件，在项目的源文件上右击添加新项目，选择C++文件，但是文件名使用.asm扩展名

然后在asm文件中填入代码：
```asm
extrn MessageBoxA: proc
 
;64位没有 .model 宏指令，不能指定内存模型和调用约定
 
.data
text db 'Hello World', 0
caption db 'Selph First x64 Application', 0
 
.code
WinMain proc
sub rsp,28h ; 函数调用前需要预留影子空间，对齐rsp
xor r9d,r9d
lea r8, caption
lea rdx, text
xor rcx,rcx
call MessageBoxA ; 函数调用使用fastcall
add rsp,28h
WinMain ENDP
END ; 最后直接end，不用指明符号
```
设置项目的类型为windows：右击项目，属性，链接器，系统，在子系统里选择窗口（/subsystem:windows）

并在链接器，高级里设置入口为WinMain

然后编译生成项目，生成前确保工具栏显示的是 debug - x64，运行生成出来的exe文件会看到弹出hello world 窗口。

## 调试汇编程序

当我们在汇编代码中设置一个断点，然后开始调试，在这个断点停下时，visual studio的调试菜单的窗口里会多出一些选项，比如寄存器、反汇编、内存，点击寄存器，会显示出寄存器的值，点击反汇编，会在源代码中显示相应的机器码，点击内存能看到内存的内容，这些信息将帮助我们方便地调试。

---

# 三、

---

# 例子

```x86asm
.486
.MODEL FLAT
.CODE
PUBLIC _myFunc
_myFunc PROC
  ; 子程序开始
  push ebp     ; 保存旧的基指针值
  mov ebp, esp ; 设置新的基准指针值。
  sub esp, 4   ; 为一个4字节的局部变量分配空间。
  push edi     ; 保存函数的寄存器值
  push esi     ; 将进行修改。此函数使用EDI和ESI。
  ; (无需保存EBX、EBP或ESP)

  ; 子程序正文
  mov eax, [ebp+8]   ; 将参数1的值移动到EAX
  mov esi, [ebp+12]  ; 将参数2的值移动到ESI中
  mov edi, [ebp+16]  ; 将参数3的值移动到EDI中

  mov [ebp-4], edi   ; 将EDI移动到本地变量中
  add [ebp-4], esi   ; 将ESI添加到本地变量中
  add eax, [ebp-4]   ; 添加局部变量的内容
                     ; 转换为EAX（最终结果）

  ; 子程序结束
  pop esi      ; 恢复寄存器值
  pop edi      ; 恢复寄存器值
  mov esp, ebp ; 取消分配局部变量
  pop ebp      ; 恢复调用方的基指针值
  ret
_myFunc ENDP
END
```

---

> 版权声明©：
>
> 本文为 CHA.ATY 的原创文章，遵循 [CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-sa/4.0/) 许可证进行授权，转载请附上原文出处链接及本声明。
>
> 作者：CHA.ATY
>
> 邮箱：2165150141@qq.com